---
- module_defaults:
    group/infoblox.bloxone.all:
      csp_url: "{{ csp_url }}"
      api_key: "{{ api_key }}"

  block:
    - ansible.builtin.set_fact:
        principal: "DNS/ns.b1ddi.ms47.com"
        tag_value: "tf_acc_test"

    - name: Get Kerberos key information by principal
      infoblox.bloxone.kerberos_keys_info:
        filters:
          principal: "{{ principal }}"
      register: kerberos_info
    - name: Assert Kerberos key properties
      assert:
        that:
          - kerberos_info.objects | length == 5
          - kerberos_info.objects[0].algorithm is defined
          - kerberos_info.objects[0].domain is defined
          - kerberos_info.objects[0].id is defined
          - kerberos_info.objects[0].principal == "DNS/ns.b1ddi.ms47.com"
          - kerberos_info.objects[0].uploaded_at is defined
          - kerberos_info.objects[0].version is defined

    - name: Get Kerberos key information by tag filter
      infoblox.bloxone.kerberos_keys_info:
        tag_filters:
          used_for: "{{ tag_value }}"
      register: kerberos_info
    - name: Assert Kerberos key properties
      assert:
        that:
          - kerberos_info.objects | length == 5
          - kerberos_info.objects[0].algorithm is defined
          - kerberos_info.objects[0].domain is defined
          - kerberos_info.objects[0].id is defined
          - kerberos_info.objects[0].principal == "DNS/ns.b1ddi.ms47.com"
          - kerberos_info.objects[0].tags.used_for == "tf_acc_test"
          - kerberos_info.objects[0].uploaded_at is defined
          - kerberos_info.objects[0].id is defined