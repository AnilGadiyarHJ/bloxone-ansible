---
#TODO: add tests
# The following require additional plugins to be supported.
# - Forward Zone with Hosts
# - Forward Zone with Internal Forwarders
# - Forward Zone with NSGs
-
- module_defaults:
    group/infoblox.bloxone.all:
      csp_url: "{{ csp_url }}"
      api_key: "{{ api_key }}"
  block:
    # Create a random Forward Zone FQDN to avoid conflicts
    - ansible.builtin.set_fact:
        fqdn: "fw-zone-{{ 999999 | random | string }}.com."
        host_display_name: "test_infra_host_anil"
        absolute_name: "test_dns_host_01."
        dns_server_name: "-dns-server-{{ 999999 | random | string }}"

    - name: Retrieve Infra Host Information
      infoblox.bloxone.infra_host_info:
        filters:
          display_name: "{{ host_display_name }}"
      register: infra_host_info
    - name: Assert Infra Host Exists
      assert:
        that:
          - infra_host_info is not failed
          - infra_host_info.objects | length == 1

    - name: Create a DNS Server
      infoblox.bloxone.dns_server:
        name: "{{ dns_server_name }}"
        state: present
      register: dns_server
    - name: Get Information about the DNS Server
      infoblox.bloxone.dns_server_info:
        filters:
          name: "{{ dns_server_name }}"
      register: dns_server_info
    - assert:
        that:
          - dns_server is changed
          - dns_server_info is not failed
          - dns_server_info.objects | length == 1

#    - name: Simulate DNS Host Creation (Check Mode)
#      infoblox.bloxone.dns_host:
#        id: "{{ infra_host_info.objects[0].legacy_id }}"
#        absolute_name: "{{ absolute_name }}"
#        server: "{{ dns_server_info.objects[0].id }}"
#        state: present
#      check_mode: true
#      register: dns_host
#    - name: Assert Check Mode Simulated Changes
#      assert:
#        that:
#          - dns_host is changed
#        fail_msg: "DNS Host '{{ absolute_name }}' did not simulate creation properly."

    - name: Retrieve the Existing DNS Host
      infoblox.bloxone.infra_host_info:
        filters:
          display_name: "ZTP_jt_yg_6002105851565412243"
      register: dns_host_info
    - name: update absoule name for DNS Host
      infoblox.bloxone.dns_host:
       absolute_name: "{{ absolute_name }}"
       id: "{{ dns_host_info.objects[0].legacy_id }}"
       server: "{{ dns_server_info.objects[0].id }}"
       state: present
      register: dns_host
    - name: Assert DNS Host Exists
      assert:
        that:
          - dns_host is changed
          - dns_host_info is not failed
          - dns_host_info.objects | length == 1
